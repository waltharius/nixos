#+TITLE: Multi-Host NixOS Configuration
#+AUTHOR: Marcin
#+DATE: 2026-01-13
#+OPTIONS: toc:2 num:nil

* Overview

This repository contains a declarative, reproducible NixOS configuration for multiple hosts using Nix flakes, home-manager, Colmena deployment, and sops-nix for secret management.

** Hosts

*** Workstations

| Host   | Hardware             | Purpose    | Special Features          |
|--------+----------------------+------------+---------------------------|
| sukkub | ThinkPad P50, no bat | Test/POC   | Basic setup               |
| azazel | T16 Gen3, 128GB RAM  | Production | TLP, hibernate, 45GB swap |

*** Servers

| Host          | Type | IP            | Purpose              | Services       |
|---------------+------+---------------+----------------------+----------------|
| nixos-test    | LXC  | 192.168.50.6  | Template & Testing   | Base template  |
| actual-budget | LXC  | 192.168.50.11 | Budget Management    | Actual Budget  |

** Key Features

*** General
- ✅ Multi-host configuration with shared modules
- ✅ Btrfs with compression (zstd:3) for root and home
- ✅ Home-manager for user-level configuration
- ✅ Sops-nix for encrypted secrets management
- ✅ Reproducible builds with flake.lock

*** Workstations
- ✅ GNOME desktop environment
- ✅ Suspend-then-hibernate (azazel only)
- ✅ Comprehensive Neovim setup with LSP

*** Servers
- ✅ Colmena for centralized deployment
- ✅ Shared SOPS keys across all servers
- ✅ Proxmox LXC template for rapid provisioning
- ✅ Role-based service modules
- ✅ Automatic Atuin login across all servers
- ✅ Dedicated nixadm user (root SSH disabled)
- ✅ FreeIPA DNS integration

* Repository Structure

#+begin_src
nixos/
├── flake.nix                      # Main flake configuration
├── flake.lock                     # Locked dependency versions
├── colmena.nix                    # Colmena deployment targets
├── .sops.yaml                     # SOPS public keys (safe to commit)
├── .gitignore                     # Prevents committing secrets
├── hosts/
│   ├── workstations/              # Desktop/laptop systems
│   │   ├── sukkub/
│   │   │   ├── configuration.nix
│   │   │   └── hardware-configuration.nix
│   │   └── azazel/
│   │       ├── configuration.nix
│   │       └── hardware-configuration.nix
│   └── servers/                   # Server systems (LXC, VM, physical)
│       ├── nixos-test/            # Template & test server
│       │   ├── configuration.nix
│       │   └── hardware-configuration.nix
│       └── actual-budget/         # Actual Budget server
│           ├── configuration.nix
│           └── hardware-configuration.nix
├── modules/
│   ├── system/                    # Common system modules
│   │   ├── boot.nix               # Systemd-boot + UEFI
│   │   ├── networking.nix         # NetworkManager, SSH
│   │   ├── locale.nix             # Polish locale settings
│   │   ├── gnome.nix              # GNOME desktop
│   │   └── secrets.nix            # SOPS configuration
│   ├── laptop/                    # Laptop-specific modules
│   │   ├── tlp.nix                # Battery optimization
│   │   └── hibernate.nix          # Suspend-then-hibernate
│   └── servers/                   # Server-specific modules
│       ├── base-lxc.nix           # Base LXC container config
│       ├── users.nix              # nixadm user definition
│       └── roles/                 # Service-specific roles
│           └── actual-budget.nix  # Actual Budget service
├── users/
│   ├── marcin/                    # Workstation user
│   │   └── home.nix
│   └── nixadm/                    # Server admin user
│       └── home.nix
├── scripts/
│   └── create-server-from-template.sh  # New server creation
├── secrets/
│   ├── .gitignore                 # Blocks decrypted files
│   ├── common.yaml                # Shared secrets (encrypted)
│   ├── sukkub.yaml                # Sukkub secrets (encrypted)
│   ├── azazel.yaml                # Azazel secrets (encrypted)
│   ├── atuin-password.txt         # Atuin password (encrypted)
│   └── atuin-key.txt              # Atuin encryption key (encrypted)
└── docs/                          # Documentation
    ├── README.md                  # Documentation index
    ├── SERVER-DEPLOYMENT.org      # Server deployment guide
    └── ...                        # Other guides
#+end_src

* Installation Guide

** Prerequisites

- NixOS 25.11 minimal ISO
- Internet connection
- UEFI-capable system
- For azazel: sufficient disk space for 45GB swap

** Workstation Installation

See main installation guide in docs/INSTALLATION.md

** Server Deployment

For detailed server deployment instructions, see [[file:docs/SERVER-DEPLOYMENT.org][docs/SERVER-DEPLOYMENT.org]]

*** Quick Start

#+begin_src bash
# Create new server from template
./scripts/create-server-from-template.sh hostname 111 192.168.50.11

# Deploy with Colmena
colmena apply --on hostname
#+end_src

* Server Management

** Deployment with Colmena

*** Deploy to Single Server

#+begin_src bash
# Deploy to specific server
colmena apply --on nixos-test

# Deploy with verbose output
colmena apply --on actual-budget --verbose
#+end_src

*** Deploy to Multiple Servers

#+begin_src bash
# Deploy to all servers with tag
colmena apply --on @production

# Deploy to all LXC containers
colmena apply --on @lxc

# Deploy to all servers
colmena apply
#+end_src

*** Useful Colmena Commands

#+begin_src bash
# List all managed servers
colmena list

# Show server information
colmena nix-info --on nixos-test

# Execute command on servers
colmena exec --on @lxc -- systemctl status

# Reboot servers
colmena exec --on nixos-test -- sudo reboot
#+end_src

** Creating New Servers

*** From Proxmox Template

#+begin_src bash
# Create new LXC from template
./scripts/create-server-from-template.sh bookstack 112 192.168.50.12

# Add to colmena.nix
# bookstack = mkServerDeployment "bookstack" "192.168.50.12" ["production" "lxc"];

# Create configuration
mkdir -p hosts/servers/bookstack
cat > hosts/servers/bookstack/configuration.nix <<EOF
{...}: {
  imports = [
    ./hardware-configuration.nix
    ../../../modules/servers/base-lxc.nix
    ../../../modules/servers/roles/bookstack.nix
  ];
  
  networking.hostName = "bookstack";
  system.stateVersion = "25.11";
  
  services.server-role.bookstack.enable = true;
}
EOF

# Deploy
colmena apply --on bookstack
#+end_src

** Server SOPS Key Management

All servers share a single SOPS key for simplified secret management:

#+begin_src bash
# Key location on all servers
/var/lib/sops-nix/key.txt

# Public key in .sops.yaml
&servers-shared age1qu4pnzn2teff7m78nrhzq4vct4qczp2ajhfda559xgpk2n08qswqzyh2aw

# All servers can decrypt secrets encrypted for 'servers-shared'
#+end_src

⚠️ *Important*: The template contains the SOPS key. All cloned servers will have the same key and can decrypt the same secrets.

* Secrets Management with SOPS

** Security Model

*** What's in the Repository (SAFE)

- ✅ Public keys in ~.sops.yaml~
- ✅ Encrypted secret files (~*.yaml~, ~*.txt~)
- ✅ SOPS configuration

*** What's NOT in the Repository (PRIVATE)

- ❌ Private age keys (~keys.txt~, ~/var/lib/sops-nix/key.txt~)
- ❌ Decrypted secrets (~*.dec~ files)
- ❌ Any ~.key~ files

** Key Types

| Key Type       | Location                      | Purpose           | Backup? |
|----------------+-------------------------------+-------------------+---------|
| Personal       | ~~/.config/sops/age/keys.txt~ | Edit secrets      | YES     |
| Host (sukkub)  | ~/var/lib/sops-nix/key.txt~   | Decrypt on host   | YES     |
| Host (azazel)  | ~/var/lib/sops-nix/key.txt~   | Decrypt on host   | YES     |
| Servers Shared | ~/var/lib/sops-nix/key.txt~   | All servers share | YES     |

** Creating/Editing Secrets

#+begin_src bash
# Edit secrets (automatically encrypted on save)
sops secrets/atuin-password.txt

# View decrypted content
sops -d secrets/atuin-password.txt

# Create new secret for all servers
sops secrets/new-service-password.txt
#+end_src

** Adding Server Secrets

Server secrets are encrypted with the ~servers-shared~ key defined in ~.sops.yaml~:

#+begin_src yaml
# In .sops.yaml
creation_rules:
  # Server secrets - shared by all servers
  - path_regex: secrets/atuin-(password|key)\.txt$
    key_groups:
      - age:
          - *admin
          - *sukkub
          - *azazel
          - *servers-shared
#+end_src

All servers cloned from the template can decrypt these secrets automatically.

* Daily Usage

** Workstations

*** Rebuilding System

#+begin_src bash
# Test configuration (doesn't modify boot entry)
sudo nixos-rebuild test --flake /etc/nixos#sukkub

# Apply and set as default boot option
sudo nixos-rebuild switch --flake /etc/nixos#sukkub

# Build for next boot (doesn't activate now)
sudo nixos-rebuild boot --flake /etc/nixos#sukkub
#+end_src

** Servers

*** Deploying Changes

#+begin_src bash
# Deploy to single server
colmena apply --on nixos-test

# Deploy to all servers
colmena apply

# Deploy only servers with tag
colmena apply --on @production
#+end_src

*** Checking Server Status

#+begin_src bash
# SSH to server
ssh nixadm@192.168.50.6

# Check service status
systemctl status actual-budget

# View logs
journalctl -u actual-budget -f

# Check failed services
systemctl --failed

# Exit
exit
#+end_src

** Updating Packages

#+begin_src bash
# Update flake.lock
nix flake update

# Update specific input
nix flake lock --update-input nixpkgs

# Rebuild workstation
sudo nixos-rebuild switch --flake /etc/nixos#sukkub

# Deploy to servers
colmena apply
#+end_src

** Rolling Back

*** Workstations

#+begin_src bash
# List generations
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

# Rollback to previous generation
sudo nixos-rebuild switch --rollback

# Switch to specific generation
sudo nix-env --switch-generation 42 --profile /nix/var/nix/profiles/system
sudo /nix/var/nix/profiles/system/bin/switch-to-configuration switch
#+end_src

*** Servers

#+begin_src bash
# Rollback on server
ssh nixadm@192.168.50.6
sudo nixos-rebuild switch --rollback
#+end_src

** Garbage Collection

#+begin_src bash
# Workstation: Delete old generations (keeps last 3)
sudo nix-collect-garbage --delete-older-than 3

# Optimize store (deduplicate)
sudo nix-store --optimise

# Servers: Run on each server
colmena exec --on @lxc -- sudo nix-collect-garbage --delete-older-than 7
#+end_src

* Laptop-Specific Features (Azazel Only)

** TLP Power Management

TLP is configured to optimize battery life:

- *AC*: Performance mode, full CPU, charging to 80%
- *Battery*: Power-save mode, 30% CPU max, aggressive power saving

** Suspend-then-Hibernate

*** How It Works

1. Close lid → System suspends to RAM (fast, consumes power)
2. After 3 hours → Automatically hibernates to disk (no power consumption)
3. Open lid → Resume from RAM (if <3h) or disk (if >3h)

*** Configuration

Configured in ~modules/laptop/hibernate.nix~:

- Suspend delay: 3 hours
- Swap size: 45GB (safe for 128GB RAM)
- Lid close: suspend-then-hibernate
- Power button: suspend-then-hibernate

*** Testing Hibernate

⚠️ *Warning*: Save all work before testing!

#+begin_src bash
# Test hibernate
sudo systemctl hibernate

# Test suspend-then-hibernate
sudo systemctl suspend-then-hibernate

# Monitor hibernate process
journalctl -f -u systemd-hibernate.service
#+end_src

* Customization

** Adding a New Workstation

1. Create host directory:
   #+begin_src bash
   mkdir -p hosts/workstations/newhostname
   #+end_src

2. Copy template:
   #+begin_src bash
   cp hosts/workstations/sukkub/configuration.nix hosts/workstations/newhostname/
   #+end_src

3. Add to ~flake.nix~:
   #+begin_src nix
   nixosConfigurations = {
     # ... existing hosts ...
     newhostname = mkHost "workstations/newhostname" "x86_64-linux";
   };
   #+end_src

4. Generate age key during installation
5. Add public key to ~.sops.yaml~

** Adding a New Server

See [[file:docs/SERVER-DEPLOYMENT.org][Server Deployment Guide]] for complete instructions.

Quick version:

1. Create from template:
   #+begin_src bash
   ./scripts/create-server-from-template.sh newserver 113 192.168.50.13
   #+end_src

2. Add to ~colmena.nix~:
   #+begin_src nix
   newserver = mkServerDeployment "newserver" "192.168.50.13" ["production" "lxc"];
   #+end_src

3. Create host configuration:
   #+begin_src bash
   mkdir -p hosts/servers/newserver
   # Create configuration.nix
   #+end_src

4. Deploy:
   #+begin_src bash
   colmena apply --on newserver
   #+end_src

** Adding System Packages

Edit ~hosts/HOSTNAME/configuration.nix~:

#+begin_src nix
environment.systemPackages = with pkgs; [
  neovim
  git
  your-package-here
];
#+end_src

** Adding User Packages

Edit ~users/marcin/home.nix~ or ~users/nixadm/home.nix~:

#+begin_src nix
home.packages = with pkgs; [
  firefox
  thunderbird
  your-package-here
];
#+end_src

* Troubleshooting

** Build Fails with Missing Hardware Configuration

The placeholder ~hardware-configuration.nix~ files must be replaced with actual generated files:

#+begin_src bash
nixos-generate-config --root /mnt
cp /mnt/etc/nixos/hardware-configuration.nix hosts/HOSTNAME/
#+end_src

** SOPS Decryption Fails

Check that:

1. Host age key exists: ~ls -la /var/lib/sops-nix/key.txt~
2. Public key is in ~.sops.yaml~
3. Secrets were re-encrypted: ~sops updatekeys secrets/*.yaml~

** Colmena Deployment Fails

#+begin_src bash
# Check SSH connectivity
ssh nixadm@192.168.50.6

# Verify server is in colmena.nix
colmena list

# Deploy with verbose output
colmena apply --on nixos-test --verbose
#+end_src

** Server Can't Decrypt Secrets

All servers use the shared ~servers-shared~ key. Verify:

1. Key exists on server: ~ssh nixadm@SERVER cat /var/lib/sops-nix/key.txt~
2. Public key matches ~.sops.yaml~: ~age-keygen -y /var/lib/sops-nix/key.txt~
3. Secrets are encrypted for ~servers-shared~: ~sops -d secrets/atuin-password.txt~

** Hibernate Fails

Check swap size:

#+begin_src bash
swapon --show
free -h
#+end_src

Swap must be larger than used RAM. Increase swap size in ~modules/laptop/hibernate.nix~.

** System Won't Boot

Boot into previous generation from GRUB menu, then investigate:

#+begin_src bash
journalctl -xb
nixos-rebuild switch --rollback
#+end_src

* Resources

** Official Documentation
- [[https://nixos.org/manual/nixos/stable/][NixOS Manual]]
- [[https://nix-community.github.io/home-manager/][Home Manager Manual]]
- [[https://colmena.cli.rs/][Colmena Documentation]]
- [[https://github.com/Mic92/sops-nix][sops-nix Documentation]]

** Tools
- [[https://github.com/FiloSottile/age][age Encryption Tool]]
- [[https://wiki.archlinux.org/title/Btrfs][Btrfs Wiki]]
- [[https://actualbudget.org/][Actual Budget]]

** Repository-Specific Guides
- [[file:docs/SERVER-DEPLOYMENT.org][Server Deployment Guide]]
- [[file:docs/INSTALLATION.md][Workstation Installation Guide]]
- [[file:docs/POST-INSTALL-SOPS-SETUP.md][SOPS Setup Guide]]

* License

This configuration is provided as-is for personal use.
